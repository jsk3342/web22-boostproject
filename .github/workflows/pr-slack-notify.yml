name: PR Slack Notification

on:
  pull_request:
    types: [opened, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Set reviewers based on branch
        id: set-reviewers
        run: |
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          if [[ $TARGET_BRANCH == "dev-fe" ]]; then
            echo "team=FE" >> $GITHUB_OUTPUT
            echo "reviewers=<@U07GSBHPCPR> <@U07H6QLFPBM> <@U07H9CTPC9J>" >> $GITHUB_OUTPUT
            echo "reviewer_names=ê¹€ì§€ìˆ˜, ê³ ë¯¼ì§€, í™ì°½í˜„" >> $GITHUB_OUTPUT
          elif [[ $TARGET_BRANCH == "dev-be" ]]; then
            echo "team=BE" >> $GITHUB_OUTPUT
            echo "reviewers=<@U07GSBPT9ST> <@U07H0978N14>" >> $GITHUB_OUTPUT
            echo "reviewer_names=ê¹€ì˜ê¸¸, ê¹€ì¤€ì„œ" >> $GITHUB_OUTPUT
          fi

      - name: Process PR title and body
        id: pr_process
        run: |
          # PR ì œëª© ì²˜ë¦¬
          title='${{ github.event.pull_request.title }}'
          title="${title//'"'/'\\"'}"
          echo "title=${title}" >> $GITHUB_OUTPUT

          # PR ë‚´ìš© ì²˜ë¦¬
          body='${{ github.event.pull_request.body }}'
          # Remove HTML comments and their content
          body=$(echo "$body" | sed 's/<!--.*-->//g')
          # Remove image markdown
          body=$(echo "$body" | sed 's/<img[^>]*>//g')
          # Remove issue numbers
          body=$(echo "$body" | sed 's/#[0-9]*//g')
          # Clean up markdown headers and special characters
          body=$(echo "$body" | sed 's/##/*/g' | tr -d '\r')
          # Escape quotes and backslashes
          body="${body//\\/\\\\}"
          body="${body//\"/\\\"}"
          # Convert newlines to spaces
          body=$(echo "$body" | tr '\n' ' ' | sed 's/  */ /g')
          echo "body=${body}" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ” *ìƒˆë¡œìš´ ${{ steps.set-reviewers.outputs.team }} PRì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ì„±ì:*\n<@${{ github.event.pull_request.user.login }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PR ì œëª©:*\n<${{ github.event.pull_request.html_url }}|${{ steps.pr_process.outputs.title }}>"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PR ì„¤ëª…:*\n${{ steps.pr_process.outputs.body }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ‘‰ ${{ steps.set-reviewers.outputs.reviewers }} ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤!"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "âœ¨ ë¦¬ë·°ì–´: ${{ steps.set-reviewers.outputs.reviewer_names }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}